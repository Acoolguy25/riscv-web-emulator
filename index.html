<html>
  <head>
    <meta content="text/html;charset=utf-8" http-equiv="Content-Type"/>
    <style>
    #terminal {
      background-color: #000;
      color: #fff;
      border-style: none;
      resize: none;
      width: 100%;
      height: 90%;
    }
    </style>
  </head>
  <body>
    <script type="module">
      import init, { WasmRiscv } from "./wasm/riscv_rust.js";

      let wasm;
      let currentRiscv;
      const inputs = [];

      const run = async () => {
        const terminal = document.getElementById('terminal');
        terminal.value = '';

        if (currentRiscv) {
          currentRiscv.running = false;
          currentRiscv.free();
        }

        const selectElement = document.getElementById('file-select');
        const selectedOption = selectElement.selectedOptions[0];
        const filename = selectedOption.value;
        const isLinux = filename === 'linux/bbl';
        const isXv6 = filename === 'xv6/kernel';

        if (isLinux) {
          terminal.value += 'login name: root\n';
          terminal.value += 'Password: busybear\n';
          terminal.value += 'It takes time to boot. Thank you for your patience.\n\n';
        }

        const elfResponse = await fetch(filename);
        const elfBuffer = await elfResponse.arrayBuffer();

        let fsBuffer;
        let dtbBuffer;

        if (isLinux) {
          const fsResponse = await fetch('linux/busybear.bin');
          fsBuffer = await fsResponse.arrayBuffer();
          const dtbResponse = await fetch('linux/dtb.dtb');
          dtbBuffer = await dtbResponse.arrayBuffer();
        } else if (isXv6) {
          const fsResponse = await fetch('xv6/fs.img');
          fsBuffer = await fsResponse.arrayBuffer();
          dtbBuffer = new ArrayBuffer(0); // dummy
		} else {
          throw new Error('Unknown program.');
        }

        const riscv = WasmRiscv.new();
        currentRiscv = riscv;
        riscv.running = false;
        riscv.init(new Uint8Array(elfBuffer), new Uint8Array(fsBuffer), new Uint8Array(dtbBuffer));

        const outputToTerminal = () => {
          const output_bytes = [];
          while (true) {
            const output_data = riscv.get_output();
            if (output_data !== 0) {
              output_bytes.push(output_data);
            } else {
              break;
            }
          }
          if (output_bytes.length > 0) {
            terminal.value += u8s_to_strings(output_bytes);
            terminal.scrollTop = terminal.scrollHeight ;
          }
		};

        const run_cycles = () => {
          if (!riscv.running) {
            return;
          }
          setTimeout(run_cycles, 0);
          riscv.run_cycles(0x10000);
          outputToTerminal();
          while (inputs.length > 0) {
            riscv.put_input(inputs.shift());
          }
        };
        riscv.running = true;
        run_cycles();
      };

      const setupTerminal = () => {
        const terminal = document.getElementById('terminal');
        terminal.addEventListener('keydown', event => {
          if (!currentRiscv || !currentRiscv.running) {
            return;
		  }
          let value = 0;
          switch (event.keyCode) {
            // @TODO: Support more special characters
            case 13: // new line
              value = 0xa;
              break;
            case 16: // shift
            case 37: // cursors
            case 38:
            case 39:
            case 40:
              break;
            case 32: // space
              value = 0x20;
              break;
            default:
              value = event.key.charCodeAt(0);
              break;
          }
          if (value > 0) {
            inputs.push(value);
          }
          event.preventDefault();
        }, false);
	  };

      init()
        .then(_wasm => {
          wasm = _wasm;
          setupTerminal();
          const runButton = document.getElementById('run-button');
          runButton.addEventListener('click', run);
          runButton.disabled = false;
        })
        .catch(error => console.error(error));

      const charTable = {};

      const u8_to_char = u8 => {
        if (charTable[u8] === undefined) {
          charTable[u8] = String.fromCharCode(u8);
        }
        return charTable[u8];
      };

      const u8s_to_strings = u8s => {
        let s = '';
        for (const u8 of u8s) {
          s += u8_to_char(u8);
        }
        return s;
      };
    </script>
    <select id="file-select">
      <option value="linux/bbl" selected>Linux</option>
      <option value="xv6/kernel">xv6 (tiny OS)</option>
    </select>
	<button id="run-button" disabled>Run</button>
<textarea id="terminal" readonly>
Message from the emulator author Takahiro:

This is RISC-V processor emulator written in Rust and compiled to WebAssembly.
You can run the RISC-V port of Linux or xv6 (UNIX V6 rewritten by MIT for x86)
on your browser. Select OS from the list and press Run button.

The emulator is still very slow. It takes time to boot. Thank you for your
patience. Some special character inputs are not handled correctly yet.

Enjoy RISC-V and Operating System on browser!

</textarea><br />
    <div>
      <a href="https://risc-v-getting-started-guide.readthedocs.io/en/latest/linux-qemu.html">Linux</a>, <a href="https://github.com/mit-pdos/xv6-riscv" target="_blank">xv6</a> on <a href="https://github.com/takahirox/riscv-rust" target="_blank">RISC-V processor emulator in Rust+WASM</a>
    </div>
  </body>
</html>